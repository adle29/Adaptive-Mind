(function(e,t,n){"use strict";function o(n,r){this.el=n;this.$el=e(n);this.options=e.extend({},s,r);this.$document=e(this.$el[0].ownerDocument);this.$window=e(t);this._defaults=s;this._name="Pep";this.moveTrigger=this.isTouch()?"touchmove":"mousemove";this.startTrigger=this.isTouch()?"touchstart":"mousedown";this.stopTrigger=this.isTouch()?"touchend":"mouseup";this.stopEvents=[this.stopTrigger,this.options.stopEvents].join(" ");if(this.options.constrainTo==="parent"){this.$container=this.$el.parent()}else if(this.options.constrainTo==="window"){this.$container=this.$document}this.CSSEaseHash=this.getCSSEaseHash();this.scale=1;this.disabled=false;this.resetVelocityQueue();this.init()}var r="pep",i=t.document,s={debug:false,activeClass:"pep-active",multiplier:1,velocityMultiplier:1.9,shouldPreventDefault:true,stopEvents:"",hardwareAccelerate:true,useCSSTranslation:true,disableSelect:true,cssEaseString:"cubic-bezier(0.190, 1.000, 0.220, 1.000)",cssEaseDuration:750,shouldEase:true,droppable:false,droppableActiveClass:"pep-dpa",overlapFunction:false,constrainTo:false,removeMargins:true,axis:null,forceNonCSS3Movement:false,drag:function(){},start:function(){},stop:function(){},rest:function(){}};o.prototype.init=function(){var e=this;if(this.options.debug)this.buildDebugDiv();if(this.options.disableSelect)this.disableSelect();this.positionParent();this.placeObject();this.ev={};this.pos={};this.subscribe()};o.prototype.subscribe=function(){var e=this;this.$el.bind(this.startTrigger,function(t){e.handleStart(t)});this.$document.bind(this.stopEvents,function(t){e.handleStop(t)});this.$document.bind(this.moveTrigger,function(t){e.moveEvent=t})};o.prototype.handleStart=function(t){var n=this;if(this.isValidMoveEvent(t)&&!this.disabled){this.log({type:"event",event:t.type});if(this.options.hardwareAccelerate&&!this.hardwareAccelerated){this.hardwareAccelerate();this.hardwareAccelerated=true}this.options.start(t,this);clearTimeout(this.restTimeout);this.$el.addClass([this.options.activeClass,"pep-start"].join(" "));this.removeCSSEasing();this.ev.x=this.isTouch()?t.originalEvent.pageX:t.pageX;this.ev.y=this.isTouch()?t.originalEvent.pageY:t.pageY;this.moveEvent=t;this.active=true;if(this.options.shouldPreventDefault)t.preventDefault();(function r(){if(!n.active)return;n.handleMove();n.requestAnimationFrame(r)})(e,n)}};o.prototype.handleMove=function(){var e=this.moveEvent;if(typeof e==="undefined")return;var t=this.isTouch()?e.originalEvent.touches[0].pageX:e.pageX;var n=this.isTouch()?e.originalEvent.touches[0].pageY:e.pageY;this.addToLIFO({time:e.timeStamp,x:t,y:n});var r,i;if(e.type===this.startTrigger){r=0;i=0}else{r=t-this.ev.x;i=n-this.ev.y}this.dx=r;this.dy=i;this.ev.x=t;this.ev.y=n;if(r===0&&i===0){this.log({type:"event",event:"** stopped **"});return}if(this.options.droppable){this.calculateActiveDropRegions()}var s=this.options.drag(e,this);if(s===false){this.resetVelocityQueue();return}this.log({type:"event",event:e.type});this.log({type:"event-coords",x:this.ev.x,y:this.ev.y});this.log({type:"velocity"});var o=this.handleConstraint(r,i);if(!this.shouldUseCSSTranslation()){var u=r>=0?"+="+Math.abs(r/this.scale)*this.options.multiplier:"-="+Math.abs(r/this.scale)*this.options.multiplier;var a=i>=0?"+="+Math.abs(i/this.scale)*this.options.multiplier:"-="+Math.abs(i/this.scale)*this.options.multiplier;if(this.options.constrainTo){u=o.x!==false?o.x:u;a=o.y!==false?o.y:a}this.moveTo(u,a)}else{r=r/this.scale*this.options.multiplier;i=i/this.scale*this.options.multiplier;if(this.options.constrainTo){r=o.x===false?r:0;i=o.y===false?i:0}this.moveToUsingTransforms(r,i)}};o.prototype.handleStop=function(e){if(!this.active)return;this.log({type:"event",event:e.type});this.active=false;this.$el.removeClass("pep-start").addClass("pep-ease");if(this.options.droppable){this.calculateActiveDropRegions()}if(this.options.shouldEase)this.ease(e);this.options.stop(e,this);this.resetVelocityQueue()};o.prototype.resetVelocityQueue=function(){this.velocityQueue=new Array(5)};o.prototype.moveTo=function(e,t,n){n=n===false||typeof n==="undefined"?false:true;if(this.options.axis==="x"){t="+=0"}else if(this.options.axis==="y"){e="+=0"}var r=300;this.log({type:"delta",x:e,y:t});if(n){this.$el.animate({top:t,left:e},r,"easeOutCirc",{queue:false})}else{this.$el.stop(true,false).css({top:t,left:e})}};o.prototype.moveToUsingTransforms=function(e,t){if(this.options.axis==="x")t=0;if(this.options.axis==="y")e=0;var n=this.matrixToArray(this.matrixString());if(!this.cssX)this.cssX=parseInt(n[4],10);if(!this.cssY)this.cssY=parseInt(n[5],10);this.cssX=this.cssX+e;this.cssY=this.cssY+t;this.log({type:"delta",x:e,y:t});n[4]=this.cssX;n[5]=this.cssY;this.translation=this.arrayToMatrix(n);this.$el.css({"-webkit-transform":this.translation,"-moz-transform":this.translation,"-ms-transform":this.translation,"-o-transform":this.translation,transform:this.translation})};o.prototype.matrixString=function(){var e=function(e){return!(!e||e==="none"||e.indexOf("matrix")===-1)};var t="matrix(1, 0, 0, 1, 0, 0)";if(e(this.$el.css("-webkit-transform")))t=this.$el.css("-webkit-transform");if(e(this.$el.css("-moz-transform")))t=this.$el.css("-moz-transform");if(e(this.$el.css("-ms-transform")))t=this.$el.css("-ms-transform");if(e(this.$el.css("-o-transform")))t=this.$el.css("-o-transform");if(e(this.$el.css("transform")))t=this.$el.css("transform");return t};o.prototype.matrixToArray=function(e){return e.split("(")[1].split(")")[0].split(",")};o.prototype.arrayToMatrix=function(e){return"matrix("+e.join(",")+")"};o.prototype.addToLIFO=function(e){var t=this.velocityQueue;t=t.slice(1,t.length);t.push(e);this.velocityQueue=t};o.prototype.ease=function(e){var t=this.$el.position();var n=this.velocity();var r=this.dt;var i=n.x/this.scale*this.options.multiplier;var s=n.y/this.scale*this.options.multiplier;var o=this.handleConstraint(i,s);if(this.cssAnimationsSupported())this.$el.css(this.getCSSEaseHash());var u=n.x>0?"+="+i:"-="+Math.abs(i);var a=n.y>0?"+="+s:"-="+Math.abs(s);if(this.options.constrainTo){u=o.x!==false?o.x:u;a=o.y!==false?o.y:a}var f=!this.cssAnimationsSupported()||this.options.forceNonCSS3Movement;this.moveTo(u,a,f);var l=this;this.restTimeout=setTimeout(function(){if(l.options.droppable){l.calculateActiveDropRegions()}l.options.rest(e,l);l.$el.removeClass([l.options.activeClass,"pep-ease"].join(" "))},this.options.cssEaseDuration)};o.prototype.velocity=function(){var e=0;var t=0;for(var n=0;n<this.velocityQueue.length-1;n++){if(this.velocityQueue[n]){e+=this.velocityQueue[n+1].x-this.velocityQueue[n].x;t+=this.velocityQueue[n+1].y-this.velocityQueue[n].y;this.dt=this.velocityQueue[n+1].time-this.velocityQueue[n].time}}return{x:e*this.options.velocityMultiplier,y:t*this.options.velocityMultiplier}};o.prototype.requestAnimationFrame=function(e){return t.requestAnimationFrame&&t.requestAnimationFrame(e)||t.webkitRequestAnimationFrame&&t.webkitRequestAnimationFrame(e)||t.mozRequestAnimationFrame&&t.mozRequestAnimationFrame(e)||t.oRequestAnimationFrame&&t.mozRequestAnimationFrame(e)||t.msRequestAnimationFrame&&t.msRequestAnimationFrame(e)||t.setTimeout(e,1e3/60)};o.prototype.positionParent=function(){if(!this.options.constrainTo||this.parentPositioned)return;this.parentPositioned=true;if(this.options.constrainTo==="parent"){this.$container.css({position:"relative"})}else if(this.options.constrainTo==="window"&&this.$container.css("position")!=="static"){this.$container.css({position:"static"})}};o.prototype.placeObject=function(){if(this.objectPlaced)return;this.objectPlaced=true;this.offset=this.options.constrainTo==="parent"||this.hasNonBodyRelative()?this.$el.position():this.$el.offset();if(parseInt(this.$el.css("left"),10))this.offset.left=this.$el.css("left");if(parseInt(this.$el.css("top"),10))this.offset.top=this.$el.css("top");if(this.options.removeMargins)this.$el.css({margin:0});this.$el.css({position:"absolute",top:this.offset.top,left:this.offset.left})};o.prototype.hasNonBodyRelative=function(){return this.$el.parents().filter(function(){var t=e(this);return t.is("body")||t.css("position")==="relative"}).length>1};o.prototype.setScale=function(e){this.scale=e};o.prototype.setMultiplier=function(e){this.options.multiplier=e};o.prototype.removeCSSEasing=function(){if(this.cssAnimationsSupported())this.$el.css(this.getCSSEaseHash(true))};o.prototype.disableSelect=function(){this.$el.css({"-webkit-touch-callout":"none","-webkit-user-select":"none","-khtml-user-select":"none","-moz-user-select":"none","-ms-user-select":"none","user-select":"none"})};o.prototype.handleConstraint=function(t,r){var i=this.$el.position();this.pos.x=i.left;this.pos.y=i.top;var s={x:false,y:false};var o,u,a,f;this.log({type:"pos-coords",x:this.pos.x,y:this.pos.y});if(e.isArray(this.options.constrainTo)){if(this.options.constrainTo[3]!==n&&this.options.constrainTo[1]!==n){u=this.options.constrainTo[1];a=this.options.constrainTo[3]}if(this.options.constrainTo[0]!==false&&this.options.constrainTo[2]!==false){o=this.options.constrainTo[2];f=this.options.constrainTo[0]}if(this.pos.x+t<a)s.x=a;if(this.pos.y+r<f)s.y=f}else if(typeof this.options.constrainTo==="string"){u=this.$container.width()-this.$el.outerWidth();o=this.$container.height()-this.$el.outerHeight();if(this.pos.x+t<0)s.x=0;if(this.pos.y+r<0)s.y=0}if(this.pos.x+t>u)s.x=u;if(this.pos.y+r>o)s.y=o;return s};o.prototype.getCSSEaseHash=function(e){if(typeof e==="undefined")e=false;var t;if(e){t=""}else if(this.CSSEaseHash){return this.CSSEaseHash}else{t=["all",this.options.cssEaseDuration+"ms",this.options.cssEaseString].join(" ")}return{"-webkit-transition":t,"-moz-transition":t,"-ms-transition":t,"-o-transition":t,transition:t}};o.prototype.calculateActiveDropRegions=function(){var t=this;this.activeDropRegions=[];e.each(e(this.options.droppable),function(n,r){var i=e(r);if(t.isOverlapping(i,t.$el)){i.addClass(t.options.droppableActiveClass);t.activeDropRegions.push(i)}else{i.removeClass(t.options.droppableActiveClass)}})};o.prototype.isOverlapping=function(e,t){if(this.options.overlapFunction){return this.options.overlapFunction(e,t)}var n=e[0].getBoundingClientRect();var r=t[0].getBoundingClientRect();return!(n.right<r.left||n.left>r.right||n.bottom<r.top||n.top>r.bottom)};o.prototype.isTouch=function(e){if(typeof Modernizr!=="undefined")return Modernizr.touch;if("ontouchstart"in t||t.DocumentTouch&&i instanceof DocumentTouch){return true}else{return false}};o.prototype.isValidMoveEvent=function(e){if(!this.isTouch()||this.isTouch()&&e.originalEvent.hasOwnProperty("touches")&&e.originalEvent.touches.length===1){return true}else{return false}};o.prototype.shouldUseCSSTranslation=function(){if(typeof this.useCSSTranslation!=="undefined")return this.useCSSTranslation;var e=false;if(!this.options.useCSSTranslation||typeof Modernizr!=="undefined"&&!Modernizr.csstransforms){e=false}else{e=true}this.useCSSTranslation=e;return e};o.prototype.cssAnimationsSupported=function(){if(typeof this.cssAnimationsSupport!=="undefined"){return this.cssAnimationsSupport}if(typeof Modernizr!=="undefined"&&Modernizr.cssanimations){this.cssAnimationsSupport=true;return true}var e=false,t=i.createElement("div"),r="animation",s="",o="Webkit Moz O ms Khtml".split(" "),u="";if(t.style.animationName){e=true}if(e===false){for(var a=0;a<o.length;a++){if(t.style[o[a]+"AnimationName"]!==n){u=o[a];r=u+"Animation";s="-"+u.toLowerCase()+"-";e=true;break}}}this.cssAnimationsSupport=e;return e};o.prototype.hardwareAccelerate=function(){this.$el.css({"-webkit-perspective":1e3,perspective:1e3,"-webkit-backface-visibility":"hidden","backface-visibility":"hidden"})};o.prototype.getMovementValues=function(){return{ev:this.ev,pos:this.pos,velocity:this.velocity()}};o.prototype.buildDebugDiv=function(){var t;if(e("#pep-debug").length===0){t=e("<div></div>");t.attr("id","pep-debug").append("<div style='font-weight:bold; background: red; color: white;'>DEBUG MODE</div>").append("<div id='pep-debug-event'>no event</div>").append("<div id='pep-debug-ev-coords'>event coords: <span class='pep-x'>-</span>, <span class='pep-y'>-</span></div>").append("<div id='pep-debug-pos-coords'>position coords: <span class='pep-x'>-</span>, <span class='pep-y'>-</span></div>").append("<div id='pep-debug-velocity'>velocity: <span class='pep-x'>-</span>, <span class='pep-y'>-</span></div>").append("<div id='pep-debug-delta'>Î” movement: <span class='pep-x'>-</span>, <span class='pep-y'>-</span></div>").css({position:"fixed",bottom:5,right:5,zIndex:99999,textAlign:"right",fontFamily:"Arial, sans",fontSize:10,border:"1px solid #DDD",padding:"3px",background:"white",color:"#333"})}var n=this;setTimeout(function(){n.debugElements={$event:e("#pep-debug-event"),$velocityX:e("#pep-debug-velocity .pep-x"),$velocityY:e("#pep-debug-velocity .pep-y"),$dX:e("#pep-debug-delta .pep-x"),$dY:e("#pep-debug-delta .pep-y"),$evCoordsX:e("#pep-debug-ev-coords .pep-x"),$evCoordsY:e("#pep-debug-ev-coords .pep-y"),$posCoordsX:e("#pep-debug-pos-coords .pep-x"),$posCoordsY:e("#pep-debug-pos-coords .pep-y")}},0);e("body").append(t)};o.prototype.log=function(e){if(!this.options.debug)return;switch(e.type){case"event":this.debugElements.$event.text(e.event);break;case"pos-coords":this.debugElements.$posCoordsX.text(e.x);this.debugElements.$posCoordsY.text(e.y);break;case"event-coords":this.debugElements.$evCoordsX.text(e.x);this.debugElements.$evCoordsY.text(e.y);break;case"delta":this.debugElements.$dX.text(e.x);this.debugElements.$dY.text(e.y);break;case"velocity":var t=this.velocity();this.debugElements.$velocityX.text(Math.round(t.x));this.debugElements.$velocityY.text(Math.round(t.y));break}};o.prototype.toggle=function(e){if(typeof e==="undefined"){this.disabled=!this.disabled}else{this.disabled=!e}};e.fn[r]=function(t){return this.each(function(){if(!e.data(this,"plugin_"+r)){var n=new o(this,t);e.data(this,"plugin_"+r,n);e.pep.peps.push(n)}})};e.pep={};e.pep.peps=[];e.pep.toggleAll=function(t){e.each(this.peps,function(e,n){n.toggle(t)})};e.pep.unbind=function(e){var t=e.data("plugin_"+r);if(typeof t==="undefined")return;t.toggle(false);e.removeData("plugin_"+r)}})(jQuery,window)